# 直播流辩题设置接口文档

## 概述

本文档描述了为直播小程序设置辩题功能的接口规范。每个直播流可以设置一个独立的辩题，实现"一个直播流对应一个辩题"的功能。

## 接口列表

### 1. 为直播流设置辩题（创建/更新）

**接口地址：** `POST /api/v1/admin/streams/{stream_id}/debate-topic`

**请求方法：** `POST`

**请求头：**
```
Content-Type: application/json
Authorization: Bearer {token}  // 如果需要认证
```

**路径参数：**
- `stream_id` (string, 必填) - 直播流ID

**请求体：**
```json
{
  "title": "如果有一个一键消除痛苦的按钮，你会按吗",
  "description": "这是一个关于痛苦、成长与人性选择的深度辩论",
  "leftPosition": "会按",
  "rightPosition": "不会按"
}
```

**请求参数说明：**

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| title | string | 是 | 辩题标题 |
| description | string | 否 | 辩题描述 |
| leftPosition | string | 是 | 正方立场（左方） |
| rightPosition | string | 是 | 反方立场（右方） |

**响应示例：**

成功响应（200）：
```json
{
  "success": true,
  "message": "辩题设置成功",
  "data": {
    "id": "debate-001",
    "streamId": "e7502378-f805-43e6-9f08-962dc2d2cf47",
    "title": "如果有一个一键消除痛苦的按钮，你会按吗",
    "description": "这是一个关于痛苦、成长与人性选择的深度辩论",
    "leftPosition": "会按",
    "rightPosition": "不会按",
    "createdAt": "2025-01-30T10:00:00.000Z",
    "updatedAt": "2025-01-30T10:00:00.000Z"
  }
}
```

错误响应（400）：
```json
{
  "success": false,
  "message": "参数验证失败：title 不能为空",
  "error": "VALIDATION_ERROR"
}
```

错误响应（404）：
```json
{
  "success": false,
  "message": "直播流不存在",
  "error": "STREAM_NOT_FOUND"
}
```

---

### 2. 更新直播流辩题

**接口地址：** `PUT /api/v1/admin/streams/{stream_id}/debate-topic`

**请求方法：** `PUT`

**请求头：**
```
Content-Type: application/json
Authorization: Bearer {token}
```

**路径参数：**
- `stream_id` (string, 必填) - 直播流ID

**请求体：**
```json
{
  "title": "我是彭于晏（更新）",
  "description": "更新后的描述",
  "leftPosition": "会按",
  "rightPosition": "不会按"
}
```

**请求参数说明：** 与创建接口相同

**响应示例：**

成功响应（200）：
```json
{
  "success": true,
  "message": "辩题更新成功",
  "data": {
    "id": "debate-001",
    "streamId": "e7502378-f805-43e6-9f08-962dc2d2cf47",
    "title": "我是彭于晏（更新）",
    "description": "更新后的描述",
    "leftPosition": "会按",
    "rightPosition": "不会按",
    "createdAt": "2025-01-30T10:00:00.000Z",
    "updatedAt": "2025-01-30T10:30:00.000Z"
  }
}
```

错误响应（404）：
```json
{
  "success": false,
  "message": "该直播流尚未设置辩题",
  "error": "DEBATE_TOPIC_NOT_FOUND"
}
```

---

### 3. 获取直播流辩题

**接口地址：** `GET /api/v1/admin/streams/{stream_id}/debate-topic`

**请求方法：** `GET`

**请求头：**
```
Authorization: Bearer {token}  // 如果需要认证
```

**路径参数：**
- `stream_id` (string, 必填) - 直播流ID

**响应示例：**

成功响应（200）：
```json
{
  "success": true,
  "data": {
    "id": "debate-001",
    "streamId": "e7502378-f805-43e6-9f08-962dc2d2cf47",
    "title": "我是彭于晏",
    "description": "这是一个关于痛苦、成长与人性选择的深度辩论",
    "leftPosition": "会按",
    "rightPosition": "不会按",
    "createdAt": "2025-01-30T10:00:00.000Z",
    "updatedAt": "2025-01-30T10:00:00.000Z"
  }
}
```

错误响应（404）：
```json
{
  "success": false,
  "message": "该直播流尚未设置辩题",
  "error": "DEBATE_TOPIC_NOT_FOUND"
}
```

---

### 4. 删除直播流辩题

**接口地址：** `DELETE /api/v1/admin/streams/{stream_id}/debate-topic`

**请求方法：** `DELETE`

**请求头：**
```
Authorization: Bearer {token}
```

**路径参数：**
- `stream_id` (string, 必填) - 直播流ID

**响应示例：**

成功响应（200）：
```json
{
  "success": true,
  "message": "辩题删除成功"
}
```

错误响应（404）：
```json
{
  "success": false,
  "message": "该直播流尚未设置辩题",
  "error": "DEBATE_TOPIC_NOT_FOUND"
}
```

---

### 5. 获取直播流列表（包含辩题信息）

**接口地址：** `GET /api/admin/streams?includeDebateTopic=true` 或 `GET /api/v1/admin/streams?includeDebateTopic=true`

**请求方法：** `GET`

**请求头：**
```
Authorization: Bearer {token}
```

**查询参数：**
- `includeDebateTopic` (boolean, 可选) - 是否包含辩题信息，默认 false

**注意：** 接口路径可能因后端实现而异，请根据实际后端接口路径调整。如果使用 `/api/admin/streams`，则需确保该接口支持 `includeDebateTopic` 参数。

**响应示例：**

成功响应（200）：
```json
{
  "success": true,
  "data": {
    "streams": [
      {
        "id": "e7502378-f805-43e6-9f08-962dc2d2cf47",
        "name": "测试直播流",
        "url": "https://test-streams.mux.dev/x36xhzz/x36xhzz.m3u8",
        "type": "hls",
        "enabled": true,
        "createdAt": "2025-10-30T06:26:43.833Z",
        "updatedAt": "2025-10-30T06:26:43.834Z",
        "debateTopic": {
          "id": "debate-001",
          "title": "我是彭于晏",
          "description": "这是一个关于痛苦、成长与人性选择的深度辩论",
          "leftPosition": "会按",
          "rightPosition": "不会按",
          "updatedAt": "2025-01-30T10:00:00.000Z"
        }
      }
    ],
    "total": 1
  }
}
```

---

## 小程序端接口（兼容现有接口）

### 获取辩题信息（已存在，需支持 stream_id）

**接口地址：** `GET /api/v1/debate-topic?stream_id={stream_id}`

**请求方法：** `GET`

**查询参数：**
- `stream_id` (string, 可选) - 直播流ID，不传则使用全局辩题

**响应示例：**

成功响应（200）：
```json
{
  "success": true,
  "data": {
    "id": "debate-001",
    "title": "我是彭于晏",
    "description": "这是一个关于痛苦、成长与人性选择的深度辩论",
    "leftPosition": "会按",
    "rightPosition": "不会按"
  }
}
```

**注意：** 
- 此接口已存在于 `utils/api-service.js` 中，后端需要确保支持 `stream_id` 参数
- 如果直播流没有设置辩题，应返回 404 错误，或返回全局辩题（根据业务需求决定）
- 小程序端会自动处理字段兼容性：后端可以返回 `leftPosition/rightPosition` 或 `leftSide/rightSide`，前端会自动转换

---

## 数据模型

### 辩题数据模型

```typescript
interface DebateTopic {
  id: string;                    // 辩题ID（唯一标识）
  streamId: string;              // 关联的直播流ID
  title: string;                 // 辩题标题（必填）
  description?: string;          // 辩题描述（可选）
  leftPosition: string;          // 正方立场（必填）- 后端返回此字段
  rightPosition: string;         // 反方立场（必填）- 后端返回此字段
  leftSide?: string;             // 正方立场（兼容字段）- 前端会自动从 leftPosition 转换
  rightSide?: string;             // 反方立场（兼容字段）- 前端会自动从 rightPosition 转换
  createdAt: string;             // 创建时间（ISO 8601格式）
  updatedAt: string;             // 更新时间（ISO 8601格式）
}
```

**字段说明：**
- 后端应返回 `leftPosition` 和 `rightPosition` 字段
- 前端会自动兼容处理，同时支持 `leftSide/rightSide` 字段名
- 如果后端返回 `leftSide/rightSide`，前端也能正常处理

### 直播流数据模型（扩展）

```typescript
interface Stream {
  id: string;                    // 直播流ID
  name: string;                  // 流名称
  url: string;                   // 流地址
  type: 'hls' | 'rtmp' | 'flv';  // 流类型
  enabled: boolean;              // 是否启用
  createdAt: string;             // 创建时间
  updatedAt: string;             // 更新时间
  debateTopic?: DebateTopic;     // 关联的辩题（可选）
}
```

---

## 业务规则

1. **一对一关系**：每个直播流只能设置一个辩题，如果重复设置会覆盖原有辩题
2. **必填字段**：设置辩题时，`title`、`leftPosition`、`rightPosition` 为必填项
3. **可选字段**：`description` 为可选项
4. **删除操作**：删除辩题后，该直播流将没有关联的辩题，小程序端会使用全局辩题
5. **全局辩题**：
   - 如果直播流没有设置辩题，小程序端应使用全局辩题（通过 `/api/v1/debate-topic` 不传 `stream_id` 获取）
   - 后端应在以下情况返回全局辩题：
     - 直播流没有设置辩题时
     - 直播流已删除辩题后
     - `stream_id` 参数不存在或无效时（可选，根据业务需求）

6. **字段名称兼容性**：
   - 后端返回字段：`leftPosition`、`rightPosition`
   - 前端自动兼容：同时支持 `leftSide`、`rightSide`
   - 小程序端会自动转换字段名，确保显示正常

---

## 错误码说明

| 错误码 | HTTP状态码 | 说明 |
|--------|-----------|------|
| VALIDATION_ERROR | 400 | 参数验证失败 |
| STREAM_NOT_FOUND | 404 | 直播流不存在 |
| DEBATE_TOPIC_NOT_FOUND | 404 | 辩题不存在 |
| UNAUTHORIZED | 401 | 未授权（需要登录） |
| FORBIDDEN | 403 | 无权限 |
| INTERNAL_ERROR | 500 | 服务器内部错误 |

---

## 接口调用示例

### 示例1：为直播流设置辩题

```javascript
// 前端调用示例
const streamId = 'e7502378-f805-43e6-9f08-962dc2d2cf47';
const debateData = {
  title: '我是彭于晏',
  description: '这是一个关于痛苦、成长与人性选择的深度辩论',
  leftPosition: '会按',
  rightPosition: '不会按'
};

const response = await fetch(`/api/v1/admin/streams/${streamId}/debate-topic`, {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${token}`
  },
  body: JSON.stringify(debateData)
});

const result = await response.json();
```

### 示例2：获取直播流辩题

```javascript
// 前端调用示例
const streamId = 'e7502378-f805-43e6-9f08-962dc2d2cf47';

const response = await fetch(`/api/v1/admin/streams/${streamId}/debate-topic`, {
  method: 'GET',
  headers: {
    'Authorization': `Bearer ${token}`
  }
});

const result = await response.json();
```

### 示例3：小程序端获取辩题

```javascript
// 小程序端调用示例（已存在于 utils/api-service.js）
const streamId = 'e7502378-f805-43e6-9f08-962dc2d2cf47';
const debate = await apiService.getDebateTopic(streamId);
```

---

## 数据库设计建议

### 辩题表（debate_topics）

```sql
CREATE TABLE debate_topics (
  id VARCHAR(36) PRIMARY KEY,
  stream_id VARCHAR(36) NOT NULL UNIQUE,
  title VARCHAR(255) NOT NULL,
  description TEXT,
  left_position VARCHAR(255) NOT NULL,
  right_position VARCHAR(255) NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  FOREIGN KEY (stream_id) REFERENCES streams(id) ON DELETE CASCADE,
  INDEX idx_stream_id (stream_id)
);
```

**说明：**
- `stream_id` 设置 `UNIQUE` 约束，确保一个直播流只能有一个辩题
- 使用 `ON DELETE CASCADE`，删除直播流时自动删除关联的辩题
- 添加索引以提高查询性能

---

## 注意事项

1. **兼容性**：
   - 确保新接口不影响现有的全局辩题功能
   - 小程序端已实现字段兼容处理，支持 `leftPosition/rightPosition` 和 `leftSide/rightSide`
   - 后端返回 `leftPosition/rightPosition` 即可，前端会自动转换

2. **权限控制**：
   - 管理接口（`/api/v1/admin/streams/{stream_id}/debate-topic`）需要管理员权限认证
   - 小程序端接口（`/api/v1/debate-topic`）通常不需要认证，但需要确保安全

3. **数据验证**：
   - 后端需要验证必填字段：`title`、`leftPosition`、`rightPosition`
   - 验证字符串长度限制（建议：title 最大 255 字符，position 最大 100 字符）
   - 验证 `stream_id` 是否存在

4. **错误处理**：
   - 所有接口都需要完善的错误处理机制
   - 404 错误：直播流不存在或辩题不存在
   - 400 错误：参数验证失败
   - 401/403 错误：权限不足

5. **日志记录**：
   - 建议记录辩题设置、更新、删除的操作日志
   - 记录操作人、操作时间、操作内容

6. **接口路径统一**：
   - 管理接口统一使用 `/api/v1/admin/streams/{stream_id}/debate-topic`
   - 小程序端接口使用 `/api/v1/debate-topic?stream_id={stream_id}`
   - 获取直播流列表接口可能是 `/api/admin/streams` 或 `/api/v1/admin/streams`，需根据实际后端实现调整

7. **响应格式统一**：
   - 所有接口应遵循统一的响应格式：`{success: boolean, data: {...}, message: string}`
   - 成功时 `success: true`，失败时 `success: false`

---

## 更新日志

- **2025-01-30**：初始版本，定义直播流辩题设置接口规范

